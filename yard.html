<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Three</title>
  <script type="text/javascript" src="three.min.js"></script>
  <script src="OrbitControls.js"></script>
  <script src="TransformControls.js"></script>
  <script src="stats.min.js"></script>

</head>
<body>
<div id="WebGLCanvas"></div>

<script type="text/javascript">

var camera, scene, renderer, stats, mouse, raycaster;

var transformControl;

var objects = [];
var particleMaterial;

			function init() {
				scene = new THREE.Scene();
				
				camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
				//camera.position.set( 0, 1.3, 3 );
				 camera.position.set(-10, 5, 15); 
				 camera.lookAt(scene.position); 
				 scene.add(camera); 
				
				//Grid
				scene.add( new THREE.GridHelper(20, 1) );
				
				mouse = new THREE.Vector2();
				raycaster = new THREE.Raycaster();
				
				particleMaterial = new THREE.MeshPhongMaterial( {color: 0xD3D3D3, shininess: 150,  map: groundTexture } );

				// Lights
				scene.add( new THREE.AmbientLight( 0x505050 ) );

				var spotLight = new THREE.SpotLight( 0xffffff );
				spotLight.angle = Math.PI / 5;
				spotLight.penumbra = 0.2;
				spotLight.position.set( 2, 3, 3 );
				spotLight.castShadow = true;
				spotLight.shadow.camera.near = 3;
				spotLight.shadow.camera.far = 10;
				spotLight.shadow.mapSize.width = 1024;
				spotLight.shadow.mapSize.height = 1024;
				scene.add( spotLight );
				

				var dirLight = new THREE.DirectionalLight( 0x55505a, 1 );
				dirLight.position.set( 0, 3, 0 );
				dirLight.castShadow = true;
				dirLight.shadow.camera.near = 1;
				dirLight.shadow.camera.far = 10;

				dirLight.shadow.camera.right = 1;
				dirLight.shadow.camera.left = - 1;
				dirLight.shadow.camera.top	= 1;
				dirLight.shadow.camera.bottom = - 1;

				dirLight.shadow.mapSize.width = 1024;
				dirLight.shadow.mapSize.height = 1024;
				scene.add( dirLight );
	
				// ***** Clipping planes: *****

				var localPlane = new THREE.Plane( new THREE.Vector3( 0, - 1, 0 ), 0.8 ),
					globalPlane = new THREE.Plane( new THREE.Vector3( - 1, 0, 0 ), 0.1 );

				// Geometry

				var material = new THREE.MeshPhongMaterial( {
						color: 0x80ee10,
						shininess: 100,
						side: THREE.DoubleSide,
						// ***** Clipping setup (material): *****
						clippingPlanes: [ localPlane ],
						clipShadows: true

					} );
					
				var groundTexture = new THREE.TextureLoader().load("img/ground.jpg"); 
				var ground = new THREE.Mesh(
						new THREE.PlaneBufferGeometry(20, 4, 1, 1),
						new THREE.MeshPhongMaterial( {color: 0xD3D3D3, shininess: 150,  map: groundTexture } ) );

				ground.rotation.x = - Math.PI / 2; // rotates X/Y to X/Z
				ground.receiveShadow = true;
				ground.position.set(-6, 0, 5);
				scene.add(ground);
				
				
				var xCount = 6;
				 var yCount = 4;
				 var zCount = 4;
				 
				 for(var i=0; i<xCount; i++){
					for(var j=0; j<yCount; j++){
						for(var k=0; k<zCount; k++){
							var boxGeometry = new THREE.BoxGeometry(2, 1, 1); 
							var neheTexture = new THREE.TextureLoader().load("img/box.gif"); 

							var boxMaterial = new THREE.MeshBasicMaterial({ 
								 map:neheTexture, 
								 side:THREE.DoubleSide 
							}); 
				  
							// Create a mesh and insert the geometry and the material. Translate the whole mesh 
							 // by 1.5 on the x axis and by 4 on the z axis and add the mesh to the scene. 
							boxMesh = new THREE.Mesh(boxGeometry, boxMaterial); 
							boxMesh.position.set(2 * (i - 3), j + 1, 4.0 - k); 
							scene.add(boxMesh); 
							
							objects.push( boxMesh );
						}
					}
				 }

				// Renderer

				renderer = new THREE.WebGLRenderer();
				renderer.shadowMap.enabled = true;
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				window.addEventListener( 'resize', onWindowResize, false );
				document.body.appendChild( renderer.domElement );

				// ***** Clipping setup (renderer): *****
				var globalPlanes = [ globalPlane ],
					Empty = Object.freeze( [] );
				renderer.clippingPlanes = Empty; // GUI sets it to globalPlanes
				renderer.localClippingEnabled = true;

				// Controls
				var controls = new THREE.OrbitControls( camera, renderer.domElement );
				controls.target.set( 0, 1, 0 );
				controls.update();


				stats = new Stats();
				document.body.appendChild( stats.dom );

				document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				document.addEventListener( 'touchstart', onDocumentTouchStart, false );


			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			
			function onDocumentTouchStart( event ) {

				event.preventDefault();

				event.clientX = event.touches[0].clientX;
				event.clientY = event.touches[0].clientY;
				onDocumentMouseDown( event );

			}

			function onDocumentMouseDown( event ) {

				event.preventDefault();

				mouse.x = ( event.clientX / renderer.domElement.clientWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / renderer.domElement.clientHeight ) * 2 + 1;

				raycaster.setFromCamera(mouse, camera);

				var intersects = raycaster.intersectObjects( objects );

				if ( intersects.length > 0 ) {

					intersects[ 0 ].object.material.color.setHex( Math.random() * 0xffffff );

					var particle = new THREE.Sprite( particleMaterial );
					particle.position.copy( intersects[ 0 ].point );
					particle.scale.x = particle.scale.y = 16;
					scene.add( particle );

				}
			}

			function render(){
				renderer.render(scene, camera);
				requestAnimationFrame(render);
			}

			init();
			render();

</script>

</body>
</html>
